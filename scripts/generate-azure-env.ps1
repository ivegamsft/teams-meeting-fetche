param(
  [string]$IaCDir = "./iac/azure",
  [string]$OutputFile = "./.env.local.azure",
  [string]$ClientSecret = "",
  [string]$WebhookSecret = ""
)

function Get-ValueOrDefault {
  param(
    [string]$Value,
    [string]$EnvVar
  )
  
  # 1. Use provided parameter if given
  if ($Value) {
    return $Value
  }
  
  # 2. Check environment variable
  if ($EnvVar -and (Test-Path "env:$EnvVar")) {
    return (Get-Item "env:$EnvVar").Value
  }
  
  # 3. Return placeholder
  return "<REPLACE_ME>"
}

$ErrorActionPreference = "Stop"

if (-not (Test-Path $IaCDir)) {
  Write-Error "IaC directory not found: $IaCDir"
  exit 1
}

Push-Location $IaCDir
try {
  $json = terraform output -json
  if (-not $json) {
    Write-Error "Terraform output is empty. Run 'terraform apply' first."
    exit 1
  }

  $outputs = $json | ConvertFrom-Json
  
  # Extract outputs (safely handle missing values)
  $kvUri = if ($outputs.key_vault_uri) { $outputs.key_vault_uri.value } else { $null }
  $kvName = if ($outputs.key_vault_name) { $outputs.key_vault_name.value } else { $null }
  $appClientId = if ($outputs.app_client_id) { $outputs.app_client_id.value } else { $null }
  $appTenantId = if ($outputs.app_tenant_id) { $outputs.app_tenant_id.value } else { $null }
  $adminGroupId = if ($outputs.admin_group_id) { $outputs.admin_group_id.value } else { $null }
  $storageAccount = if ($outputs.storage_account_name) { $outputs.storage_account_name.value } else { $null }
  $storageContainer = if ($outputs.storage_container_name) { $outputs.storage_container_name.value } else { $null }
  $eventGridUri = if ($outputs.eventgrid_topic_endpoint) { $outputs.eventgrid_topic_endpoint.value } else { $null }
  $eventGridKey = if ($outputs.eventgrid_topic_key) { $outputs.eventgrid_topic_key.value } else { $null }
  $appInsightsKey = if ($outputs.appinsights_instrumentation_key) { $outputs.appinsights_instrumentation_key.value } else { $null }

  # Get secrets from parameters or env vars
  $secret = Get-ValueOrDefault -Value $ClientSecret -EnvVar "GRAPH_CLIENT_SECRET"
  $authSecret = Get-ValueOrDefault -Value $WebhookSecret -EnvVar "WEBHOOK_AUTH_SECRET"

  $content = @(
    "# Generated by scripts/generate-azure-env.ps1",
    "# Do not commit this file",
    "",
    "# Azure Application (from Terraform)",
    "GRAPH_TENANT_ID=$(if ($appTenantId) { $appTenantId } else { '<REPLACE_ME>' })",
    "GRAPH_CLIENT_ID=$(if ($appClientId) { $appClientId } else { '<REPLACE_ME>' })",
    "GRAPH_CLIENT_SECRET=$secret",
    "ENTRA_GROUP_ID=$(if ($adminGroupId) { $adminGroupId } else { '<REPLACE_ME>' })",
    "",
    "# Key Vault",
    "AZURE_KEYVAULT_URL=$(if ($kvUri) { $kvUri } else { '<REPLACE_ME>' })",
    "AZURE_KEYVAULT_NAME=$(if ($kvName) { $kvName } else { '<REPLACE_ME>' })",
    "",
    "# Storage",
    "AZURE_STORAGE_ACCOUNT=$(if ($storageAccount) { $storageAccount } else { '<REPLACE_ME>' })",
    "AZURE_STORAGE_CONTAINER=$(if ($storageContainer) { $storageContainer } else { '<REPLACE_ME>' })",
    "",
    "# Event Grid",
    "EVENTGRID_URI=$(if ($eventGridUri) { $eventGridUri } else { '<REPLACE_ME>' })",
    "EVENTGRID_KEY=$(if ($eventGridKey) { $eventGridKey } else { '<REPLACE_ME>' })",
    "",
    "# Application Insights",
    "APPINSIGHTS_INSTRUMENTATION_KEY=$(if ($appInsightsKey) { $appInsightsKey } else { '<REPLACE_ME>' })",
    "",
    "# Required secrets (from parameters or env vars)",
    "WEBHOOK_AUTH_SECRET=$authSecret"
  ) -join "`n"

  Pop-Location
  Set-Content -Path $OutputFile -Value $content -Encoding UTF8
  Write-Host "âœ… Generated: $OutputFile"
  Write-Host "   - Values from Terraform outputs"
  Write-Host "   - Secrets from parameters/env vars"
  Write-Host "   - Remaining <REPLACE_ME> values need manual configuration"
} finally {
  if ((Get-Location).Path -eq (Resolve-Path $IaCDir).Path) {
    Pop-Location
  }
}
